
<project default="java:jar"
         xmlns:j="jelly:core">

  <postGoal name="clover">
    <copy tofile="${basedir}/target/docs/clover/style.css"
          file="${basedir}/xdocs/stylesheets/clover-style.css"
          overwrite="true"/>
    <copy tofile="${basedir}/target/docs/clover/pkgs-summary"
          file="${basedir}/target/docs/clover/pkgs-summary.html"/>
  </postGoal>

  <preGoal name="site:generate">
    <attainGoal name="clover"/>
  </preGoal>

  <goal name="classworlds:build-boot-jar" prereqs="java:compile">
    <property name="boot.classes" value="target/boot-classes"/>
    <mkdir dir="${boot.classes}"/>
    <copy todir="${boot.classes}">
      <fileset dir="${maven.build.dir}/classes">
        <include name="org/codehaus/classworlds/boot/*.class"/>
        <include name="org/codehaus/classworlds/protocol/**/*.class"/>
      </fileset> 
    </copy>

    <jar
      jarfile="${maven.build.dir}/classworlds-boot-${pom.currentVersion}.jar"
      basedir="${boot.classes}">
      <manifest>
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Created-By" value="maven"/>
        <attribute name="Package" value="${pom.package}"/>
      </manifest>
    </jar>
    
  </goal>
  
  <goal name="classworlds:assemble" prereqs="classworlds:build-boot-jar,java:jar">

    <property name="assembly"   value="target/boot-assembly"/>
    <property name="worlds.inf" value="${assembly}/WORLDS-INF"/>
    <property name="libdir"     value="${worlds.inf}/lib"/>
    <property name="confdir"     value="${worlds.inf}/conf"/>

    <copy file="target/classworlds-${pom.currentVersion}.jar" 
          tofile="${worlds.inf}/classworlds.jar"/>

    <copy todir="${libdir}">
      <fileset dir="${basedir}/test-data/">
        <include name="**/*.jar"/>
      </fileset>
    </copy>

    <copy file="classworlds.conf" 
          todir="${confdir}"/>

    <unjar src="${maven.build.dir}/classworlds-boot-${pom.currentVersion}.jar"
           dest="${assembly}">
      <patternset>
        <include name="**/*.class"/>
      </patternset>
    </unjar>

    <jar
      jarfile="${maven.build.dir}/standalone.jar"
      basedir="${assembly}">
      <manifest>
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Created-By" value="Classworlds"/>
        <attribute name="Package" value="${pom.package}"/>
        <attribute name="Main-Class" value="org.codehaus.classworlds.boot.Bootstrapper"/>
      </manifest>
    </jar>
    
  </goal>

  <goal name="compile.revolt">
    <mkdir dir="${basedir}/target/revolt-classes"/>
    <javac 
     destdir="${basedir}/target/revolt-classes"
     debug="on"
     srcdir="${basedir}/src/java/revolt/"/>
  </goal>

  <goal name="jar.revolt"
        prereqs="compile.revolt">
    <copy todir="${maven.build.dir}/revolt-classes">
      <fileset dir="${maven.src.dir}/java/revolt">
        <include name="**/*.properties"/>
      </fileset> 
    </copy>
    <jar
      jarfile="${maven.build.dir}/revolt.jar"
      basedir="${maven.build.dir}/revolt-classes"/>
  </goal>

  <goal name="revolt"
        prereqs="java:jar,jar.revolt">
    <java classname="org.codehaus.classworlds.Launcher" fork="true">
      <classpath>
        <pathelement location="${maven.build.dir}/${maven.final.name}.jar"/>
      </classpath>
      <sysproperty key="classworlds.conf" value="${maven.src.dir}/java/revolt/main1.conf"/>
    </java>
  </goal>
  
  
  <preGoal name="test:test">
  	<attainGoal name="uberjar-test"/>
  </preGoal>
  
  <goal name="uberjar-test" prereqs="java:compile,jar.revolt">
  	<echo>Creating ${maven.build.dir}/uberjar-test.jar</echo>
  	
  	<!-- Copy the static jar files -->
  	<copy todir="${maven.build.dir}/uberjar/">
  		<fileset dir="test-data/uberjar">
  			<includes name="**/*"/>
  		</fileset>
  	</copy>
  	
  	<!-- Copy the bootstrap classes -->
  	<copy todir="${maven.build.dir}/uberjar">
  		<fileset dir="${maven.build.dir}/classes">
  			<include name="org/codehaus/classworlds/boot/Bootstrapper.class"/>
  			<include name="org/codehaus/classworlds/boot/InitialClassLoader.class"/>
  			<include name="org/codehaus/classworlds/protocol/jar/Handler.class"/>
  			<include name="org/codehaus/classworlds/protocol/jar/JarUrlConnection.class"/>
  		</fileset>
  	</copy>
  	
  	<!-- Create the classworlds.jar -->
    <jar
      jarfile="${maven.build.dir}/uberjar/WORLDS-INF/classworlds.jar"
      basedir="${maven.build.dir}/classes"/>
  	
  	
  	<!-- Copy the revolt jar (contains main) -->
  	<copy file="${maven.build.dir}/revolt.jar"
  		  todir="${maven.build.dir}/uberjar/WORLDS-INF/lib"/>
  		  
    <!-- Jar it up -->
    <jar
      jarfile="${maven.build.dir}/uberjar-test.jar"
      basedir="${maven.build.dir}/uberjar">
      <manifest>
        <attribute name="Main-Class" value="org.codehaus.classworlds.boot.Bootstrapper"/>
      </manifest>
    </jar>
    
  </goal>
  
  <postGoal name="test:test">
    <java 
        jar="${maven.build.dir}/uberjar-test.jar" 
        fork="true"
        failonerror="true"/>
  </postGoal>

</project>
